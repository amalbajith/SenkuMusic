name: Build and Release SenkuMusic

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g. 1.5.0)'
        required: true
        default: '1.5.0'
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release
    runs-on: self-hosted # Change to 'macos-latest' if using GitHub Cloud Runners
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Select Xcode Version
        run: sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer

      - name: Set Version
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          # Strip 'v' prefix if present for agvtool
          CLEAN_VERSION=$(echo $VERSION | sed 's/^v//')
          cd SenkuPlayer
          agvtool new-marketing-version $CLEAN_VERSION
          agvtool next-version -all

      - name: Archive
        run: |
          xcodebuild -project SenkuPlayer/SenkuPlayer.xcodeproj \
            -scheme SenkuPlayer \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath SenkuPlayer.xcarchive \
            archive CODE_SIGNING_ALLOWED=NO

      - name: Export IPA
        run: |
          mkdir -p Payload
          cp -r SenkuPlayer.xcarchive/Products/Applications/SenkuPlayer.app Payload/
          zip -r SenkuMusic.ipa Payload
          rm -rf Payload SenkuPlayer.xcarchive

      - name: Calculate Size
        id: size
        run: |
          SIZE=$(ls -l SenkuMusic.ipa | awk '{print $5}')
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: SenkuMusic.ipa
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: "v${{ github.event.inputs.version || github.ref_name }}"
          body: "Automated build from remote runner."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
